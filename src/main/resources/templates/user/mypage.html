<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>마이페이지</title>

    <!-- Google Fonts - Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">

    <!-- 외부 CSS 파일 링크 -->
    <link rel="stylesheet" th:href="@{/css/user/mypage.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/layout.css}">
</head>
<body>

<!-- 공통 헤더 -->
<header th:replace="~{common/header.html :: header}"></header>

<div class="mypage-container">
    <div class="user-card">
        <div class="user-card-header">
            <h2>회원 정보</h2>
            <button id="logoutBtn" class="logout-btn">로그아웃</button>
        </div>

        <div class="user-info" id="userInfo" style="display: none;">
            <div class="info-item">
                <label>이름:</label>
                <span id="userName">-</span>
            </div>
            <div class="info-item">
                <label>이메일:</label>
                <span id="userEmail">-</span>
            </div>
            <div class="info-item">
                <label>아이디:</label>
                <span id="userUsername">-</span>
            </div>
            <div class="info-item">
                <label>비밀번호:</label>
                <span>••••••••</span>
                <button class="change-password-btn" onclick="showPasswordModal()">비밀번호 변경</button>
            </div>
        </div>

        <div id="loading" style="display: none; text-align: center; padding: 2rem;">
            <p>사용자 정보를 불러오는 중...</p>
        </div>

        <div id="errorMessage" style="display: none; color: red; text-align: center; padding: 2rem;">
            <p>사용자 정보를 불러올 수 없습니다.</p>
            <button onclick="loadUserInfo()">다시 시도</button>
            <button onclick="goToLogin()">로그인 페이지로</button>
        </div>
    </div>
</div>

<!-- 비밀번호 변경 모달 -->
<div id="passwordModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3>비밀번호 변경</h3>
            <span class="close" onclick="closePasswordModal()">&times;</span>
        </div>
        <div class="modal-body">
            <form id="passwordChangeForm">
                <div class="form-group">
                    <label>현재 비밀번호:</label>
                    <input type="password" id="currentPassword" class="form-control" required>
                    <div class="error-message" id="currentPassword-error"></div>
                </div>
                <div class="form-group">
                    <label>새 비밀번호:</label>
                    <input type="password" id="newPassword" class="form-control" required>
                    <div class="error-message" id="newPassword-error"></div>
                </div>
                <div class="form-group">
                    <label>새 비밀번호 확인:</label>
                    <input type="password" id="confirmPassword" class="form-control" required>
                    <div class="error-message" id="confirmPassword-error"></div>
                </div>
                <div class="form-message" id="passwordFormMessage"></div>
                <div class="modal-buttons">
                    <button type="button" class="btn-cancel" onclick="closePasswordModal()">취소</button>
                    <button type="submit" class="btn-submit">비밀번호 변경</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 공통 푸터 -->
<footer th:replace="~{common/footer.html :: footer}"></footer>

<script>
    const AuthManager = {
        setToken: function(token) {
            localStorage.setItem('auth_token', token);
        },

        getToken: function() {
            return localStorage.getItem('auth_token');
        },

        removeToken: function() {
            localStorage.removeItem('auth_token');
        },

        isLoggedIn: function() {
            return this.getToken() !== null;
        },

        redirectToLogin: function() {
            window.location.href = '/login';
        }
    };

    document.addEventListener('DOMContentLoaded', function() {
        loadUserInfo();
        document.getElementById('logoutBtn').addEventListener('click', logout);
        document.getElementById('passwordChangeForm').addEventListener('submit', changePassword);
    });

    function loadUserInfo() {
        const token = AuthManager.getToken();

        if (!token) {
            alert('로그인이 필요합니다.');
            AuthManager.redirectToLogin();
            return;
        }

        const loadingDiv = document.getElementById('loading');
        const userInfoDiv = document.getElementById('userInfo');
        const errorDiv = document.getElementById('errorMessage');

        loadingDiv.style.display = 'block';
        userInfoDiv.style.display = 'none';
        errorDiv.style.display = 'none';

        fetch('/api/auth/mypage', {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            }
        })
            .then(response => {
                if (!response.ok) {
                    if (response.status === 401) {
                        throw new Error('UNAUTHORIZED');
                    }
                    throw new Error('Network response was not ok');
                }
                return response.json();
            })
            .then(data => {
                loadingDiv.style.display = 'none';

                if (data.success && data.user) {
                    document.getElementById('userName').textContent = data.user.name || '정보 없음';
                    document.getElementById('userEmail').textContent = data.user.email || '정보 없음';
                    document.getElementById('userUsername').textContent = data.user.username || '정보 없음';

                    userInfoDiv.style.display = 'block';
                } else {
                    throw new Error('Invalid response data');
                }
            })
            .catch(error => {
                loadingDiv.style.display = 'none';

                if (error.message === 'UNAUTHORIZED') {
                    alert('로그인이 만료되었습니다. 다시 로그인해주세요.');
                    AuthManager.removeToken();
                    AuthManager.redirectToLogin();
                } else {
                    errorDiv.style.display = 'block';
                }
            });
    }

    function showPasswordModal() {
        document.getElementById('passwordModal').style.display = 'block';
        clearPasswordForm();
    }

    function closePasswordModal() {
        document.getElementById('passwordModal').style.display = 'none';
        clearPasswordForm();
    }

    function clearPasswordForm() {
        document.getElementById('currentPassword').value = '';
        document.getElementById('newPassword').value = '';
        document.getElementById('confirmPassword').value = '';
        document.getElementById('passwordFormMessage').textContent = '';
        document.getElementById('passwordFormMessage').className = 'form-message';

        // 에러 메시지 초기화
        document.querySelectorAll('.error-message').forEach(elem => {
            elem.textContent = '';
            elem.parentElement.classList.remove('show-error');
        });
    }

    function changePassword(e) {
        e.preventDefault();

        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmPassword = document.getElementById('confirmPassword').value;
        const messageDiv = document.getElementById('passwordFormMessage');

        // 클라이언트 측 검증
        if (!currentPassword || !newPassword || !confirmPassword) {
            messageDiv.textContent = '모든 필드를 입력해주세요.';
            messageDiv.className = 'form-message error-message';
            return;
        }

        if (newPassword !== confirmPassword) {
            messageDiv.textContent = '새 비밀번호와 확인 비밀번호가 일치하지 않습니다.';
            messageDiv.className = 'form-message error-message';
            return;
        }

        if (newPassword.length < 6) {
            messageDiv.textContent = '새 비밀번호는 최소 6자 이상이어야 합니다.';
            messageDiv.className = 'form-message error-message';
            return;
        }

        const token = AuthManager.getToken();

        fetch('/api/auth/change-password', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${token}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                currentPassword: currentPassword,
                newPassword: newPassword,
                confirmPassword: confirmPassword
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    messageDiv.textContent = data.message;
                    messageDiv.className = 'form-message success-message';

                    setTimeout(() => {
                        closePasswordModal();
                        alert('비밀번호가 성공적으로 변경되었습니다.');
                    }, 1000);
                } else {
                    messageDiv.textContent = data.message;
                    messageDiv.className = 'form-message error-message';
                }
            })
            .catch(error => {
                messageDiv.textContent = '비밀번호 변경 중 오류가 발생했습니다.';
                messageDiv.className = 'form-message error-message';
            });
    }

    function logout() {
        if (confirm('로그아웃 하시겠습니까?')) {
            AuthManager.removeToken();
            AuthManager.redirectToLogin();
        }
    }

    function goToLogin() {
        AuthManager.removeToken();
        AuthManager.redirectToLogin();
    }

    // 모달 외부 클릭 시 닫기
    window.onclick = function(event) {
        const modal = document.getElementById('passwordModal');
        if (event.target === modal) {
            closePasswordModal();
        }
    }
</script>

</body>
</html>