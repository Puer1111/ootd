<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${title}">회원가입</title>
    <!-- Google Fonts - Noto Sans KR -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap" rel="stylesheet">
    <!-- 외부 CSS 파일 링크 -->
    <link rel="stylesheet" th:href="@{/css/user/signup.css}">
    <link rel="stylesheet" th:href="@{/css/common/footer.css}">
    <link rel="stylesheet" th:href="@{/css/common/header.css}">
    <link rel="stylesheet" th:href="@{/css/common/layout.css}">
    <!-- 헤더 템플릿 추가 -->
    <header th:replace="~{common/header.html :: header}"></header>
</head>
<body>
<div class="container">
    <div class="left-panel">
        <h1>환영합니다</h1>
        <p>회원가입을 통해 다양한 서비스를 이용해보세요. 여러분의 참여를 기다립니다.</p>
    </div>
    <div class="right-panel">
        <div class="signup-form">
            <div class="form-header">
                <h2>회원가입</h2>
            </div>
            <form id="signupForm" action="/api/auth/signup" method="post">
                <div class="form-group">
                    <label for="username">사용자 닉네임</label>
                    <input type="text" id="username" name="username" class="form-control" required>
                    <div class="error-message" id="username-error">사용자 닉네임을 입력해주세요.</div>
                </div>
                <div class="form-group">
                    <label for="email">이메일</label>
                    <input type="email" id="email" name="email" class="form-control" required>
                    <div class="error-message" id="email-error">유효한 이메일 주소를 입력해주세요.</div>
                </div>
                <div class="form-group">
                    <label for="name">이름</label>
                    <input type="text" id="name" name="name" class="form-control" required>
                    <div class="error-message" id="name-error">이름을 입력해주세요.</div>
                </div>
                <div class="form-group">
                    <label for="password">비밀번호</label>
                    <input type="password" id="password" name="password" class="form-control" required>
                    <div class="error-message" id="password-error">비밀번호를 입력해주세요.</div>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">비밀번호 확인</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" class="form-control" required>
                    <div class="error-message" id="confirmPassword-error">비밀번호가 일치하지 않습니다.</div>
                </div>
                <div class="form-message" id="form-message"></div>
                <button type="submit" class="btn" id="submitBtn">가입하기</button>
                <div class="form-footer">
                    <p>이미 계정이 있으신가요? <a href="/login">로그인</a></p>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 푸터 템플릿 추가 -->
<footer th:replace="~{common/footer.html :: footer}"></footer>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const form = document.getElementById('signupForm');
        const username = document.getElementById('username');
        const email = document.getElementById('email');
        const name = document.getElementById('name');
        const password = document.getElementById('password');
        const confirmPassword = document.getElementById('confirmPassword');
        const formMessage = document.getElementById('form-message');

        // 오류 메시지 표시 함수
        function showError(input, message) {
            const formGroup = input.parentElement;
            formGroup.classList.add('show-error');
            const errorElement = formGroup.querySelector('.error-message');
            errorElement.textContent = message;
        }

        // 오류 메시지 초기화 함수
        function clearError(input) {
            const formGroup = input.parentElement;
            formGroup.classList.remove('show-error');
        }

        // 입력 필드 검증 함수
        function validateInput(input, validationFn, errorMessage) {
            if (!validationFn(input.value.trim())) {
                showError(input, errorMessage);
                return false;
            } else {
                clearError(input);
                return true;
            }
        }

        // 이메일 검증 함수
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }

        // 비밀번호 강도 검증 함수
        function isValidPassword(password) {
            return password.length >= 6; // 최소 6자 이상
        }

        // 각 필드 검증 이벤트 등록
        username.addEventListener('blur', function() {
            validateInput(username, value => value.length >= 2, '닉네임은 2자 이상이어야 합니다.');
        });

        email.addEventListener('blur', function() {
            validateInput(email, isValidEmail, '유효한 이메일 주소를 입력해주세요.');
        });

        name.addEventListener('blur', function() {
            validateInput(name, value => value.length >= 1, '이름을 입력해주세요.');
        });

        password.addEventListener('blur', function() {
            validateInput(password, isValidPassword, '비밀번호는 최소 6자 이상이어야 합니다.');
        });

        confirmPassword.addEventListener('blur', function() {
            validateInput(confirmPassword, value => value === password.value, '비밀번호가 일치하지 않습니다.');
        });

        // 폼 제출 처리
        form.addEventListener('submit', function(e) {
            e.preventDefault();

            // 전체 폼 검증
            const isUsernameValid = validateInput(username, value => value.length >= 2, '닉네임은 2자 이상이어야 합니다.');
            const isEmailValid = validateInput(email, isValidEmail, '유효한 이메일 주소를 입력해주세요.');
            const isNameValid = validateInput(name, value => value.length >= 1, '이름을 입력해주세요.');
            const isPasswordValid = validateInput(password, isValidPassword, '비밀번호는 최소 6자 이상이어야 합니다.');
            const isConfirmPasswordValid = validateInput(confirmPassword, value => value === password.value, '비밀번호가 일치하지 않습니다.');

            // 모든 검증이 통과되면 폼 제출
            if (isUsernameValid && isEmailValid && isNameValid && isPasswordValid && isConfirmPasswordValid) {
                // 폼 데이터를 JSON으로 변환
                const formData = {
                    username: username.value.trim(),
                    email: email.value.trim(),
                    name: name.value.trim(),
                    password: password.value
                };

                // AJAX를 사용하여 폼 제출
                fetch('/api/auth/signup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(formData)
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.message && data.message.includes('성공')) {
                            // 성공 메시지 표시
                            formMessage.textContent = '회원가입이 완료되었습니다! 로그인 페이지로 이동합니다.';
                            formMessage.classList.add('success-message');

                            // 잠시 후 로그인 페이지로 이동
                            setTimeout(() => {
                                window.location.href = '/login';
                            }, 2000);
                        } else {
                            // 오류 메시지 표시00
                            formMessage.textContent = data.message || '회원가입 중 오류가 발생했습니다.';
                            formMessage.classList.add('error-message');
                        }
                    })
                    .catch(error => {
                        formMessage.textContent = '서버 오류가 발생했습니다. 나중에 다시 시도해주세요.';
                        formMessage.classList.add('error-message');
                        console.error('Error:', error);
                    });
            }
        });
    });
</script>
</body>
</html>